import { Appear, Image, Notes, Head } from 'mdx-deck';
import { Split } from 'mdx-deck/layouts';
import highlight from '@mdx-deck/themes/syntax-highlighter-prism';

import Button from 'calcite-react/Button';
import Alert from 'calcite-react/Alert';

import Twitter from './components/Twitter';

import theme from './theme';

import 'deck.css';

export const themes = [highlight, theme];

<Head>
  <title>Arcade and ArcGIS API for Python</title>
  <link rel="shortcut icon" href="/static/favicon.ico" />
</Head>

#  Using Arcade and the ArcGIS API for Python

> _2019 Edition_

---

## Good Morning!

---

## But first, 👋🏼 I'm Grant.

---

## I work in Professional Services

---

## ~17 years working with ArcGIS

> 2 1/2 Years at Eagle

---

## This is Ryan 👋🏼 

---

## Technical Support Consultant
> 18 months at Eagle

---

## Who's here?
> What are we expecting

---

## Have we done any development?

---

## What are we using it for?

---

## Less talk

## More workshop


---

# Agenda - Python
1. Introduction to ArcGIS API for Python

2. User admin workflows with Python

3. Adding and updating content

---

# Agenda - Arcade
1. Introduction to Arcade

2. Arcade in Popups

3. Advanced Arcade

4. Arcade in Pro

---

## Before we start

- We will be using a [Notebook](https://enterprise.cloud.eaglegis.co.nz/portal) server

- Link is in the resources section

- Resources all has help links

---

## There is a GitHub Repo for this

We will put all Notebooks and Arcade snippets in to this at the end of the course.

Feel free to fork it.

[Repo] (https://github.com/carg563/workshop-arcade-and-the-arcgis-api-for-python)

---

## Login details

Your first initial followed by an _x_ and your last initial

Ryan Cooper = rxc_workshop 

Grant Carroll = gxc_workshop

Password is _gis12345_

---
## Python

---

## Overview of the API

- A Pythonic GIS API

--- 

## Architecture of the API

<img src="/static/assets/guide_api_overview_modules.png" style={{ height: '300px' }} />

---

## The GIS Module

The gis module is the most important and provides the entry point into the GIS. 
It lets you manage users, groups and content in the GIS. 
GIS admins spend a lot of time on this module.

---

## Spatial Modules

The modules in green are used to access the various spatial capabilities or geographic datasets in the GIS. These modules include a family of geoprocessing functions, types and other helper objects for working with spatial data of a particular type.

---

## Enhanced Functionality

The modules in blue provide additional functionality for your workflows. They include the geocoding module which is for finding places, the geometry module for representing the geometries of feature data and functions for working with them, the geoprocessing module that makes it easy to import third party geoprocessing tools and work with them and the geoenrichment module that helps you enrich your datasets with thematic information.

---

## Visualization

The modules in orange allow you to visualize and disseminate your GIS data and analysis. The widgets module includes the MapView Jupyter notebook widget for visualizing maps and layers, the mapping module has types and functions for working with web maps and web layers and the apps module helps you create and manage web applications built with ArcGIS.

---

```python
arcgis.gis
```
 module provides an information model for GIS hosted within ArcGIS Online or Portal for ArcGIS. This module provides functionality to manage (create, read, update and delete) GIS users, groups and content. This module is the most important and provides the entry point into the GIS.

---

```python
arcgis.env 
``` 
provides a shared environment used by the different modules. It stores globals such as the currently active GIS as well as environment settings that are common among all geoprocessing tools, such as the output spatial reference.

---

```python
arcgis.features
```
Entities located in space with a geometrical representation (such as points, lines or polygons) and a set of properties can be represented as features. The arcgis.features module is used for working with feature data, feature layers and collections of feature layers in the GIS. It also contains the spatial analysis functions which operate against feature data.

---

```python
arcgis.raster
```
Raster data is made up of a grid of cells, where each cell or pixel can have a value. Raster data is useful for storing data that varies continuously, as in a satellite image, a surface of chemical concentrations, or an elevation surface. The arcgis.raster module contains classes and raster analysis functions for working with raster data and imagery layers.

---

```python
arcgis.network
``` 
contains classes and functions for network analysis. Network layers and analysis can be used for operations such as finding the closest facility, the best route for a vehicle, the best routes for a fleet of vehicles, locating facilities using location allocation, calculating an OD cost matrix, and generating service areas.

---

```python
arcgis.schematics 
```
Schematics are simplified representations of networks, intended to explain their structure and make the way they operate understandable. The arcgis.schematics module contains the types and functions for working with schematic layers and datasets.

---

```python
arcgis.geoanalytics
``` 
provides types and functions for distributed analysis of large feature and tabular datasets. These GeoAnalytics tools work with big data registered in the GIS’s datastores as well as with feature layers.

---

```python
arcgis.geocoding
``` 
provides classes and functions for geocoding, batch geocoding and reverse geocoding. Geocoders can find point locations of addresses, business names, and so on. The output points can be visualized on a map, inserted as stops for a route, or loaded as input for spatial analysis.

---

```python
arcgis.geometry
```
 defines useful geometry types for working with geographic information and GIS functionality. It provides functions which use geometric types as input and output as well as functions for easily converting geometries between different representations.

---

```python
arcgis.geoenrichment
```
provides the ability to get facts about a location or area. Using GeoEnrichment, you can get information about the people and places in a specific area or within a certain distance or drive time from a location. You can use this data to enhance the accuracy of your predictive models or better explain the inferences you gain from them.

---

```python
arcgis.geoprocessing
```
Users can create and share geoprocessing tools in the GIS. The arcgis.geoprocessing module provides helper types with dynamically created methods to invoke these tools, and provides simple types that can be used as parameters for these tools along with native Python types.

---

```python
arcgis.realtime
``` 
module provides types and functions for receiving real-time data feeds and sensor data streamed from the GIS to perform continuous processing and analysis. It includes support for stream layers that allow Python scripts to subscribe to the streamed feature data or broadcast updates or alerts.

---

```python
arcgis.mapping
```  
module provides components for visualizing GIS data and analysis. This module includes WebMap and WebScene components that enable 2D and 3D mapping and visualization in the GIS. This module also includes mapping layers like MapImageLayer and VectorTileLayer

---

```python
arcgis.widgets
``` 
module provides components for visualizing GIS data and analysis. This module includes the MapView Jupyter notebook widget for visualizing maps and layers

---

```python
arcgis.apps 
``` 
module allows you to manage some of the web based applications available in ArcGIS.

---


## Benefits of Python automation

<img src="/static/assets/python-automation.png" style={{ height: '400px' }} />

---

## Script Creation Workflow

<img src="/static/assets/script-creation.png" style={{ height: '400px' }} />

---

## Troubleshooting Techniques

<img src="/static/assets/trouble-shooting.png" style={{ height: '300px' }} />

---

## Our scenario

- New GIS Admin in the Job

- Responsible for cleaning up Enterprise

- Need to do some clean up within the Enterprise

- Manipulate features in a more effcient way


---

<img src="/static/assets/demo-guy.png" style={{ height: '400px' }} />

## [Module One](https://github.com/carg563/workshop-arcade-and-the-arcgis-api-for-python/blob/master/src/code-samples/python/notebooks/Module%201%20-%20Introduction%20to%20the%20ArcGIS%20API%20for%20Python%20Part%20I.ipynb)

---

<img src="/static/assets/demo-guy.png" style={{ height: '400px' }} />

## [Module Two](https://github.com/carg563/workshop-arcade-and-the-arcgis-api-for-python/blob/master/src/code-samples/python/notebooks/Module%202%20-%20Introduction%20to%20the%20ArcGIS%20API%20for%20Python%20Part%20II.ipynb)

---

<img src="/static/assets/demo-guy.png" style={{ height: '400px' }} />

## [Module Three](https://github.com/carg563/workshop-arcade-and-the-arcgis-api-for-python/blob/master/src/code-samples/python/notebooks/Module%203%20-%20Removing%20Users%20from%20your%20Organisation.ipynb)

---

<img src="/static/assets/demo-guy.png" style={{ height: '400px' }} />

## [Module Four](https://github.com/carg563/workshop-arcade-and-the-arcgis-api-for-python/blob/master/src/code-samples/python/notebooks/Module%204%20-%20Add%20Users%20to%20your%20Organisation.ipynb)

---

<img src="/static/assets/demo-guy.png" style={{ height: '400px' }} />

## [Module Five](https://github.com/carg563/workshop-arcade-and-the-arcgis-api-for-python/blob/master/src/code-samples/python/notebooks/Module%205%20-%20Adding%20and%20Updating%20Content.ipynb)


---

<img src="/static/assets/demo-guy.png" style={{ height: '400px' }} />

## [Module Six](https://github.com/carg563/workshop-arcade-and-the-arcgis-api-for-python/blob/master/src/code-samples/python/notebooks/Module%206%20-%20Updating%20Content%20from%20a%20GPX%20file.ipynb)

---

## Arcade

---

## What is Arcade

Arcade is a portable, lightweight, and secure expression language written for use in the ArcGIS platform.

---

## Can create apps with it?

Arcade is not designed for writing standalone apps. It is intended solely for evaluating embedded expressions

---

## Execution Profiles

Arcade behaves differently depending on where you are using it. 

This behaviour is called the execution profile.

[Execution Profiles](https://developers.arcgis.com/arcade/guide/profiles/)

---

## Execution Profiles

The profiles are function are available in are highlighted in the reference.

<img src="/static/assets/profiles.png" style={{ height: '250px' }} />


---

## Case Sensitivity

Arcade is case insensitive

``` featuresetbyname() ```

is the same as 

``` FeatureSetByName() ```

---

## Comments

Can be set using the following syntax

```javascript
//This is a single-line comment

/*
This is a 
multi-line comment
*/
```

---

## Global variables

Global variables may be used in Arcade expressions depending on the execution profile:

```$datastore```

```$feature```

```$layer```

```$map```

```$value```

---

## Feature Sets

As the name suggests, are a set of features.  How many features will depend on your data and the functions used in the expression

---

```$map``` 

Allows you define a FeatureSet from a Feature Layer (from a feature service) that is in your map

```FeatureSetByName($map, "Urban Forestry")```

---

```$datastore```

Allows you to define a FeatureSet from any sub-layer of the Feature Layer that you’re currently working with in the Arcade editor

```FeatureSetByName($datastore, "Area_Unit_2015_V1_00_Clipped")```

---

```$layer```

Allows you to define a FeatureSet from the current layer being worked with in the Arcade editor

---

## Best Practice with FeatureSet

1. Define the minimum needed FeatureSets required to do the job

2. Always reduce your FeatureSets when you can

3. Filtering by attributes will always be faster than filtering by geometry

4. Chain functions together when possible to reduce queries

5. Use stats and sorting to avoid unnecessary loops

---

## More details on FeatureSets

[Function Reference](https://developers.arcgis.com/arcade/function-reference/data_functions/#featuresetbyname)

[Feature Sets Part 1](https://www.esri.com/arcgis-blog/products/arcgis-online/mapping/whats-new-with-arcade-taking-a-stroll-through-featuresets-part-1/)

[Feature Sets Part 2](https://www.esri.com/arcgis-blog/products/arcgis-online/mapping/whats-new-with-arcade-taking-a-stroll-through-featuresets-part-2/)

---
## Attribute Access

You can access feature attributes as global variables using the ```$feature.fieldName``` syntax.

```javascript 
var percentCollege = Round(($feature.COLLEGE / $feature.POPULATION) * 100, 2);
```

---

## Attribute Access

Attribute values can be referenced using the ```.``` syntax or with square brackets.

```javascript 
Round(($feature["COLLEGE"] / $feature["POPULATION"]) * 100, 2);
```

---

## Attribute Access

You can also reference values from joined tables using this syntax: ```$feature["joinKey.fieldName"]```

```javascript
Round((($feature["COUNTY_ID.VOTED_DEM_2016"] - $feature["COUNTY_ID.VOTED_DEM_2012"]) / $feature["COUNTY_ID.VOTED_DEM_2012"]) * 100, 2);
```

---

## If Statements

If statements may be used to support conditional logic in the script.

```javascript
function isOdd(value){
  // Returns either 1 or 0.
  // 1 = odd number
  // 0 = even number
  // Boolean() converts the raw value to a bool
  var val = Boolean(value % 2);
  if (val) {
    return "Yes. This is odd."
  }
  else {
    return "Nope. Not odd.";
  }
}
```
---

## For Loops

Looping is supported with ```for(initialization, condition, finalExpression){ // logic to execute }.```

```javascript
var result = 0;
for(var z=0; z<100; z++) {
  result += z;
}
return result; // returns 4950
```

---

## Looping through arrays

For loops can iterate through arrays.

```javascript
var myArray = [10,20,30];
for(var k in myArray) {
  n+=myArray[k];   // Note that K iterates through the index not the items
}
```

---

## Looping through dictionay keys

For loops may also iterate through keys in a dictionary.

```javascript
var myDictionary = Dictionary("field1", 1, "field2", 2)
for(var k in myDictionary) {
  n+= myDictionary[k];   // Note that K will be "field1" and then "field2"
}
```

---
## Looping through a feature set

And they may iterate through items in a FeatureSet.

```javascript
var sensitiveFeatures = Filter(publicLandFeatures, "class = 'sensitive'");
var largeAreasPresent = false;
for(var feature in sensitiveFeatures){
  largeAreasPresent = IIF(feature.ACRES > 5000, true, largeAreasPresent);
}
```

---

## Exiting loops early

Arcade also supports the ```break``` and ```continue``` statements. Using ```return``` inside the loop will exit the loop and function.

```javascript
for(var i=1; i<100; i++) {
  if (i==3) continue;

  if (i==5) break;
    n+=i;
}
```
---

## User defined functions

User defined functions are supported. Functions must be declared before they are used. Functions have local scope, meaning any variables defined in them will only exist during the call to the function.

```javascript
function adder(x, y) {
  var result = x+y;
  return result*10;
}

adder(10,2);
```

---

## Global and local scope

All variables declared at global scope will be available anywhere in the script

Variables declared inside of functions can override global scope variables, while inside the function

Available globals depend on the profile.

---

```javascript
var myglobal = 1;
function useGlobal() {
  var n = 10;    // n is only available inside of this function. ie. It is local scope.
  return myglobal * n;    // will use the globally defined variable
}

function overrideGlobal() {
  var myglobal = 1000;
  return myglobal * 10;   // will use the locally defined variable
}

var z = overrideGlobal();   // will be 10000
var k = useGlobal(); // will be 10
return z+k;  // returns 10010
```

---

## Variable scope

Variables must be declared before use. Block level scoping is not supported. This means variables defined in For loops will be available outside of the loop.

```javascript
var myglobal = 1;
for(var k=1; k<100; k++) {
  var n=10;  // Defined in Block, but will be available outside of Block.
}
return k + n;  // Will return 110
```


---

## Popups

Arcade can be used to aggregate numbers, create virtual fields and show details from other layers.

---

## Best Practice in Popups

**Avoid iterating through all features in a layer.** 

This action requires the expression to fetch all features from the service. The query itself can be slow, and depending on how many features are in your layer, the iteration can slow things down as well.

---
## Best Practice in Popups

**Chain functions as much as possible.**

If you can reduce two or three requests down to one via chaining, then do it! Limiting the number of trips to the server will keep the app more useable.

---

## Best Practice in Popups

**Keep the expression as simple as possible.** 

Using seven geometry functions in a complex 100-line expression may make you feel like an Arcade ninja, but it could cause your users to spend extra time waiting for popup content to show up while unnecessary processing takes place behind the scenes. Geometry operations can be especially slow if you are working with complex features with many vertices.

---

## Best Practice in Popups

**Keep the expression as simple as possible.** 

Using seven geometry functions in a complex 100-line expression may make you feel like an Arcade ninja, but it could cause your users to spend extra time waiting for popup content to show up while unnecessary processing takes place behind the scenes. Geometry operations can be especially slow if you are working with complex features with many vertices.


---

## Best Practice in Popups

**If you don’t need it, don’t request it!**

If you’re creating a Feature Set, only request the fields you need. If you’re not using geometry functions, then be sure to exclude geometries from the feature set. Small details like this can go a long way in improving performance.---

---

## Example on HTML and Arcade

[Click Me!](https://www.esri.com/arcgis-blog/products/arcgis-online/mapping/combining-arcade-and-html-for-a-real-life-pop-up-display/)

---

## Field Calculations

The ability to calculate fields in ArcGIS Online has been possible with SQL, which is great for large or synced datasets. However, calculating with Arcade is easy to learn, allows for more flexibility than SQL, and utilizes geospatial capabilities.

---

## Visualisation

---

[Simple Example](https://local-maps.maps.arcgis.com/home/webmap/viewer.html?webmap=0e56e5c9847c4377bd0f7d5627576406)

[More Complex](https://local-maps.maps.arcgis.com/home/webmap/viewer.html?webmap=0e56e5c9847c4377bd0f7d5627576406)

---

## Labeling

---

## Attribute Rules

[More details](https://pro.arcgis.com/en/pro-app/help/data/geodatabases/overview/an-overview-of-attribute-rules.htm)

---

## Rule Types

- Calculation Rules

- Constraint Rules

- Validation Rules


---

## Calculation Rules

Automatically populate fields in features

Can be chained together

Order is important!

---

## Constraints

Constraints enforce certain conditions

Do not update fields like attribute rules

Must return a true or false result

---

## Validation Rules

Specify permitted values on attrbutes

Offers greater flexability than the domain and subtype model

Only available on an Enterprise GDB

---

## Validation Rules Example

Concatenate an array of text field values into a specified field.


When a pipe's LifeCycleStatus is updated to Abandoned, the PressureZone attribute is updated to None.

---

## Python Resources

> [Python Guide](https://developers.arcgis.com/python/guide/overview-of-the-arcgis-api-for-python/)

> [ArcGIS Enterprise Notebook server](https://enterprise.cloud.eaglegis.co.nz/portal)

> [Sample Notebooks](https://developers.arcgis.com/python/sample-notebooks/)

> [Automate the boring stuff](https://automatetheboringstuff.com/)

> [GeoNet Community](https://community.esri.com/groups/arcgis-python-api)


---

## ArcGIS Pro Fix for Cloning Environement

> [Help !!](https://community.esri.com/docs/DOC-12021-python-at-arcgispro-22)


---

## Arcade Resources

> [Developers Site](https://developers.arcgis.com/arcade/)

> [Arcade Function Reference](https://developers.arcgis.com/arcade/function-reference/)

> [Arcade Playground](https://developers.arcgis.com/arcade/playground/)

> [Code Snippet Repository](https://github.com/Esri/arcade-expressions/)